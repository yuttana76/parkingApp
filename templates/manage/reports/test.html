<!DOCTYPE html>
<html lang="en">

<head>
    {% include "include/manage-css.html" %}
    {% include "include/manage-js.html" %}
    <!-- import library -->
</head>

<style>
    /* style declaration */
</style>


<body class="hold-transition sidebar-mini layout-fixed">
    <div class="wrapper">
        {% include "manage/comps/header.html" %}
        {% include "manage/comps/sidebar.html" %}

        <div class="content-wrapper">
            
            <div class="content-header" style="padding-top: 0px;">
                <div class="container-fluid">
                    <div class="row mb-3">
                        <!-- Datagrid Section -->
                        <div class="col-lg-12" style="margin-top: 10px;">
                            <div class="mui-panel" style="border-radius: 5px; border: 1px solid #ccc;">
                                <div class="mui-datagrid" style="border-radius: 5px; border: 1px solid #ccc;">
                                    <div class="table-container" style="overflow-x: auto;">
                                        <table class="mui-table" style="white-space: nowrap;" id="datagrid-table">
                                            <thead>
                                                <tr
                                                    style="background-color: #1a086e; color: white; border-radius: 5px;">
                                                    <th>
                                                        <div class="sort-icon-container">
                                                            Tran ID
                                                            <span id="sort-icon-tranid" class="sort-icon"></span>
                                                        </div>
                                                    </th>
                                                    <th>
                                                        <div class="sort-icon-container">
                                                            ประเภทบัตร
                                                            <span id="sort-icon-cardtype" class="sort-icon"></span>
                                                        </div>
                                                    </th>
                                                    <th>
                                                        <div class="sort-icon-container">
                                                            ประเภทรถ
                                                            <span id="sort-icon-cartype" class="sort-icon"></span>
                                                        </div>
                                                    </th>
                                                    <th>
                                                        <div class="sort-icon-container">
                                                            หมายเลขบัตร
                                                            <span id="sort-icon-cardno" class="sort-icon"></span>
                                                        </div>
                                                    </th>
                                                    <th>
                                                        <div class="sort-icon-container">
                                                            ทะเบียน
                                                            <span id="sort-icon-lisence" class="sort-icon"></span>
                                                        </div>
                                                    </th>
                                                    <th>
                                                        <div class="sort-icon-container">
                                                            ประเภทการชำระ
                                                            <span id="sort-icon-paytype" class="sort-icon"></span>
                                                        </div>
                                                    </th>
                                                    <th>
                                                        <div class="sort-icon-container">
                                                            เวลาเข้า
                                                            <span id="sort-icon-timein" class="sort-icon"></span>
                                                        </div>
                                                    </th>
                                                    <th>
                                                        <div class="sort-icon-container">
                                                            เวลาออก
                                                            <span id="sort-icon-timeout" class="sort-icon"></span>
                                                        </div>
                                                    </th>
                                                    <th>
                                                        <div class="sort-icon-container">
                                                            ระยะเวลาจอด
                                                            <span id="sort-icon-time" class="sort-icon"></span>
                                                        </div>
                                                    </th>
                                                    <th>
                                                        <div class="sort-icon-container">
                                                            ประเภทผู้ใช้งาน
                                                            <span id="sort-icon-custype" class="sort-icon"></span>
                                                        </div>
                                                    </th>
                                                </tr>
                                            </thead>
                                            <tbody id="datagrid-body"></tbody>
                                        </table>
                                    </div>
                                </div>
                                <div class="col-lg-12" style="margin-top: 15px;">
                                    <div class="row mb-3">
                                        <div class="col-lg-6" id="show-index">

                                        </div>
                                        <div class="col-lg-6 align-right"> <!-- pagination section -->
                                            <div class="pagination-container" id="pagination-container"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const table = document.querySelector('.mui-table');
        const tableBody = document.querySelector('#datagrid-body');
        const rows = tableBody.children;
        const itemsPerPage = 10;
        let currentPage = 1;
        let data;

        function initialLoad() {
            var fromDateInput = document.getElementById("fromDate");
            var toDateInput = document.getElementById("toDate");

            var today = new Date();
            var oneMonthAgo = new Date();
            oneMonthAgo.setMonth(today.getMonth() - 1);

            // Format the dates as YYYY-MM-DD (required by the date input)
            var todayFormatted = today.toISOString().split("T")[0];
            var oneMonthAgoFormatted = oneMonthAgo.toISOString().split("T")[0];

            fromDateInput.value = oneMonthAgoFormatted;
            toDateInput.value = todayFormatted;

            sendSearchData();

            var headers = document.querySelectorAll("#datagrid-table thead th");

            headers.forEach(function (header, index) {
                header.addEventListener("click", function () {
                    sortTable(index);
                });
            });
        }
        document.addEventListener("DOMContentLoaded", initialLoad);

        function assignTableData(resData, rowType = 'Data') {
            var paginatedData;
            var startIndex = (currentPage - 1) * itemsPerPage;
            var endIndex = startIndex + itemsPerPage;

            if (rowType == 'Filters') {
                filterData = JSON.parse(decodeURIComponent(resData));
                paginatedData = filterData.slice(startIndex, endIndex);
            } else {
                if (resData) {
                    encodedData = resData;
                    data = JSON.parse(decodeURIComponent(encodedData));
                }
                paginatedData = data.slice(startIndex, endIndex);
            }


            var datagridBody = document.getElementById("datagrid-body");
            var tableRows = "";

            // Loop through the data and generate HTML for each row
            paginatedData.forEach(function (row) {
                tableRows += "<tr>";
                tableRows += "<td>" + row.tran_id + "</td>";
                tableRows += "<td>" + row.card_type + "</td>";
                tableRows += "<td>" + row.vehicle_type + "</td>";
                tableRows += "<td>" + row.card_id + "</td>";
                tableRows += "<td>" + row.license_plate_no + "</td>";
                tableRows += "<td>" + row.payment_type + "</td>";
                tableRows += "<td>" + row.time_in + "</td>";
                tableRows += "<td>" + row.time_out + "</td>";
                tableRows += "<td>" + row.parking_time + "</td>";
                tableRows += "<td>" + row.visitor_type + "</td>";
                tableRows += "</tr>";
            });
            // Add the generated table rows to the datagrid body
            datagridBody.innerHTML = tableRows;

            // Update the pagination
            renderPagination(data.length);
        }

        function sendSearchData() {
            // Retrieve the values from the input fields
            var lineSelect = document.getElementById('lineSelect').value;
            var parkingSelect = document.getElementById('parkingSelect').value;
            var customerTypeSelect = document.getElementById('customerTypeSelect').value;
            var periodSelect = document.getElementById('periodSelect').value;
            var fromDate = document.getElementById('fromDate').value;
            var toDate = document.getElementById('toDate').value;
            var fromTime = document.getElementById('fromTime').value;
            var toTime = document.getElementById('toTime').value;

            var searchData = {
                lineSelect: lineSelect,
                parkingSelect: parkingSelect,
                customerTypeSelect: customerTypeSelect,
                periodSelect: periodSelect,
                fromDate: fromDate,
                toDate: toDate,
                fromTime: fromTime,
                toTime: toTime
            };

            fetch('/manage/car_in_out_report', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(searchData)
            }).then(response => response.json())
                .then(data => {
                    currentPage = 1; // set to first page
                    // Handle the response data
                    var encodedData = data.encode_data;
                    assignTableData(resData = encodedData)
                })
                .catch(error => {
                    // Handle any errors that occurred during the request
                    console.log(error);
                });
        }

        function renderPagination(totalItems) {
            var paginationContainer = document.getElementById("pagination-container");
            paginationContainer.innerHTML = "";
            var showIndexContainer = document.getElementById("show-index");

            var totalPages = Math.ceil(totalItems / itemsPerPage);
            var visiblePages = 5; // Number of visible pages (including the current page)
            var startPage = currentPage - Math.floor(visiblePages / 2);
            var endPage = currentPage + Math.floor(visiblePages / 2);

            if (startPage < 1) {
                startPage = 1;
                endPage = Math.min(visiblePages, totalPages);
            }

            if (endPage > totalPages) {
                startPage = Math.max(1, totalPages - visiblePages + 1);
                endPage = totalPages;
            }

            var startIndex = (currentPage - 1) * itemsPerPage + 1;
            var endIndex = Math.min(startIndex + itemsPerPage - 1, totalItems);
            if (totalItems > 0) {
                showIndexText = "แสดง " + startIndex + " ถึง " + endIndex + " จาก " + totalItems;
            } else {
                showIndexText = "ไม่พบข้อมูล";
            }
            showIndexContainer.innerText = showIndexText;

            var paginationUl = document.createElement("ul");
            paginationUl.classList.add("pagination");

            // Create the "First Page" button
            var firstLi = document.createElement("li");
            firstLi.classList.add("page-item");
            var firstButton = document.createElement("button");
            firstButton.innerHTML = "หน้าแรก";
            firstButton.classList.add("page-link");
            firstButton.addEventListener("click", function () {
                if (currentPage > 1) {
                    currentPage = 1;
                    assignTableData(); // Update table data without calling sendSearchData()
                }
            });
            firstButton.style.color = "#1a086e";
            firstLi.appendChild(firstButton);
            paginationUl.appendChild(firstLi);

            // Create the "Previous" button
            var prevLi = document.createElement("li");
            prevLi.classList.add("page-item");
            var prevButton = document.createElement("button");
            prevButton.innerHTML = "&laquo;";
            prevButton.classList.add("page-link");
            prevButton.addEventListener("click", function () {
                if (currentPage > 1) {
                    currentPage--;
                    assignTableData(); // Update table data without calling sendSearchData()
                }
            });
            prevButton.style.color = "#1a086e";
            prevLi.appendChild(prevButton);
            paginationUl.appendChild(prevLi);

            // Create the pagination buttons
            for (var i = startPage; i <= endPage; i++) {
                var paginationLi = document.createElement("li");
                paginationLi.classList.add("page-item");

                var paginationButton = document.createElement("button");
                paginationButton.innerText = i;
                paginationButton.classList.add("page-link");

                if (i === currentPage) {
                    paginationButton.classList.add("active");
                    paginationButton.style.backgroundColor = "#1a086e";
                    paginationButton.style.color = "#ffffff"; // Invert color for the active page
                } else {
                    paginationButton.style.color = "#1a086e"; // Set font color for non-active pages
                    paginationButton.addEventListener("click", function () {
                        currentPage = parseInt(this.innerText);
                        assignTableData(); // Update table data without calling sendSearchData()
                    });
                }

                paginationLi.appendChild(paginationButton);
                paginationUl.appendChild(paginationLi);
            }

            // Create the "Next" button
            var nextLi = document.createElement("li");
            nextLi.classList.add("page-item");
            var nextButton = document.createElement("button");
            nextButton.innerHTML = "&raquo;";
            nextButton.classList.add("page-link");
            nextButton.addEventListener("click", function () {
                if (currentPage < totalPages) {
                    currentPage++;
                    assignTableData(); // Update table data without calling sendSearchData()
                }
            });
            nextButton.style.color = "#1a086e";
            nextLi.appendChild(nextButton);
            paginationUl.appendChild(nextLi);

            // Create the "Last Page" button
            var lastLi = document.createElement("li");
            lastLi.classList.add("page-item");
            var lastButton = document.createElement("button");
            lastButton.innerHTML = "หน้าสุดท้าย";
            lastButton.classList.add("page-link");
            lastButton.addEventListener("click", function () {
                if (currentPage < totalPages) {
                    currentPage = totalPages;
                    assignTableData(); // Update table data without calling sendSearchData()
                }
            });
            lastButton.style.color = "#1a086e";
            lastLi.appendChild(lastButton);
            paginationUl.appendChild(lastLi);

            paginationContainer.appendChild(paginationUl);
        }
    </script>

    {% include "manage/comps/footer.html" %}
</body>